#! /usr/bin/env ruby
require 'rubygems'
require 'iconv'
require File.join(File.dirname(__FILE__), '..', 'lib', 'dolarhoy', 'currency')

gem 'hpricot' and require 'hpricot'

html = if ARGV.first
  File.read(ARGV.first)
else
  require 'net/http'
  require 'uri'
  
  response = Net::HTTP.start(URI.parse('http://www.dolarhoy.com').host) do |http|
    http.get('/indexx.php', 'Referer' => 'http://www.dolarhoy.com')
  end
  
  response.body
end

doc = Hpricot(Iconv.iconv('UTF-8', 'ISO-8859-1', html).first)

currencies = []

doc.search("body > div table[@bgcolor='#000000']") do |table|
  values = table.search("font[@size='3']")
  next unless values.size > 1

  currencies << Currency.new(
    table.search("td:first").inner_text,
    values[0].inner_text,
    values[1].inner_text
  )
end

puts currencies.sort.join("\n")
